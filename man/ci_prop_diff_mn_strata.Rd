% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/prop_ci_mn.R
\name{ci_prop_diff_mn_strata}
\alias{ci_prop_diff_mn_strata}
\title{Stratified Miettinen-Nurminen Confidence Interval for Difference in Proportions}
\usage{
ci_prop_diff_mn_strata(
  x,
  by,
  strata,
  method = c("score", "summary score"),
  conf.level = 0.95,
  delta = NULL,
  data = NULL
)
}
\arguments{
\item{x}{A binary vector representing all responses. Can also be a column
name if a data frame provided in the `data` argument.}

\item{by}{A character or factor vector with exactly two unique levels
identifying the two groups to compare. Can also be a column name if a data
frame provided in the `data` argument.}

\item{strata}{A vector specifying the stratum for each observation. It needs
to be the length of x or a multiple of x if multiple levels of strata are
present. Can also be a column name (or vector of column names NOT quoted)
if a data frame provided in the `data` argument.}

\item{method}{String specifying how the CI's should be calculated. It must
equal either 'score' or 'summary score'. See details for more information
about the implementation differences.}

\item{conf.level}{A numeric value between 0 and 1 specifying the confidence
level. Default is 0.95 (95\% confidence).}

\item{delta}{Optional numeric value(s) for hypothesis testing. If provided, the
function returns the test statistic and p-value under the `delta`
hypothesis.}

\item{data}{Optional data frame containing the variables specified in `x` and `by`.}
}
\value{
A list containing the following components:

  \item{estimate}{The point estimate of the difference in proportions (p_x -
  p_y)} \item{conf.low}{Lower bound of the confidence interval}
  \item{conf.high}{Upper bound of the confidence interval}
  \item{conf.level}{The confidence level used} \item{delta}{delta value used}
  \item{statistic}{Z-Statistic under the given `delta` null hypothesis}
  \item{p.value}{p-value under the given `delta` null hypothesis}
  \item{method}{Description of the method used ("Stratified
  Miettinen-Nurminen Confidence Interval")}

  If `delta` is not provided statistic and p.value will be NULL
}
\description{
Calculates the Stratified Miettinen-Nurminen (MN) confidence interval for the
difference between two proportions with stratification.
}
\details{
The function implements the stratified Miettinen-Nurminen method to compute
  confidence intervals for the difference between two proportions across multiple strata.

  For the "score" method, the approach:
  \itemize{
    \item Calculates weights for each stratum as \eqn{w_i = \frac{n_{xi} \cdot n_{yi}}{n_{xi} + n_{yi}}}
    \item Computes the overall weighted difference \eqn{\hat{\delta} = \frac{\sum w_i \hat{p}_{xi}}{\sum w_i} -
          \frac{\sum w_i \hat{p}_{yi}}{\sum w_i}}
    \item Uses the stratified test statistic: \deqn{Z_{\delta} = \frac{\hat{\delta} - \delta}
          {\sqrt{\sum_{i=1}^k \left(\frac{w_i}{\sum w_i}\right)^2 \cdot \sigma_{mn}^2(\delta)}}}
    \item Finds confidence limits where this test statistic equals critical values from the standard normal distribution
  }

  The \eqn{\sigma_{mn}^2(\delta)} is the Miettinen-Nurminen variance estimate.
  See the details of ci_prop_diff_mn() for how \eqn{\sigma_{mn}^2(\delta)} is calculated.

  For the "summary score" method, the function:
  \itemize{
    \item Calculates within-stratum confidence intervals using the Miettinen-Nurminen method
    \item Computes a weighted average of the midpoints of these intervals \eqn{d_S = \sum (lower_i + width_i/2)\cdot w_i}
    \item Weights are inversely proportional to the squared standard errors: \eqn{w_i = \frac{1/SE_i^2}{\sum 1/SE_i^2}}
    \item Standard errors are estimated as \eqn{SE_i = \frac{upper_i - lower_i}{2 \cdot z_{1-\alpha/2}}}
    \item The overall variance is \eqn{Var(d_S) = \frac{1}{\sum 1/SE_i^2}}
    \item The CI is \eqn{CI = d_S \pm z_{1-\alpha/2}\cdot \sqrt{Var(d_S)}}
  }
}
\examples{
# Generate binary samples with strata
responses <- expand(c(9, 3, 7, 2), c(10, 10, 10, 10))
arm <- rep(c("treat", "control"), 20)
strata <- rep(c("stratum1", "stratum2"), times = c(20, 20))

# Calculate stratified confidence interval for difference in proportions
ci_prop_diff_mn_strata(x = responses, by = arm, strata = strata)

# Using the summary score method
ci_prop_diff_mn_strata(x = responses, by = arm, strata = strata,
                      method = "summary score")

# Calculate 99\% confidence interval
ci_prop_diff_mn_strata(x = responses, by = arm, strata = strata,
                      conf.level = 0.99)

# Calculate p-value under null hypothesis delta = 0.2
ci_prop_diff_mn_strata(x = responses, by = arm, strata = strata,
                      delta = 0.2)

}
\references{
Miettinen, O. S., & Nurminen, M. (1985). Comparative analysis of two rates.
Statistics in Medicine, 4(2), 213-226.

SAS Institute Inc. (2013). SAS/STATÂ® 13.1 User's Guide. The FREQ Procedure.
(For the summary score method)
}
